rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Artifacts collection (main app data)
    match /artifacts/{appId}/users/{userId} {
      // Allow user to read/write their own user document
      allow read, write: if isOwner(userId);

      // Entries subcollection
      match /entries/{entryId} {
        allow read, write: if isOwner(userId);
      }

      // Patterns subcollection
      match /patterns/{patternId} {
        allow read, write: if isOwner(userId);
      }

      // NEW: Signals subcollection (single source of truth for temporal signals)
      match /signals/{signalId} {
        allow read, write: if isOwner(userId);
      }

      // NEW: Day summaries subcollection (aggregated view for heatmap/calendar)
      // Writable by user OR by Cloud Functions (service account)
      match /day_summaries/{dateId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId) || request.auth.token.admin == true;
      }

      // Goals subcollection
      match /goals/{goalId} {
        allow read, write: if isOwner(userId);
      }

      // NEW: Signal states subcollection (lifecycle tracking for goals, insights, patterns)
      match /signal_states/{stateId} {
        allow read, write: if isOwner(userId);
      }

      // NEW: Insight exclusions subcollection (dismissed patterns that shouldn't resurface)
      match /insight_exclusions/{exclusionId} {
        allow read, write: if isOwner(userId);
      }

      // NEW: Nexus 2.0 subcollection (insights, beliefs, interventions, baselines, states)
      match /nexus/{docId} {
        allow read: if isOwner(userId);
        // Allow write to all nexus docs EXCEPT conversation_queue (server-only)
        allow write: if isOwner(userId) && docId != 'conversation_queue';
      }

      // Insight engagement subcollection under nexus/
      match /nexus/{nexusDocId}/insight_engagement/{engagementId} {
        allow read, write: if isOwner(userId);
      }

      // NEW: Threads subcollection (life narrative threads for Nexus)
      match /threads/{threadId} {
        allow read, write: if isOwner(userId);
      }

      // NEW: Settings subcollection (user preferences)
      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
      }

      // Dashboard preferences subcollection
      match /preferences/{prefId} {
        allow read, write: if isOwner(userId);
      }

      // Safety plan subcollection
      match /safetyPlan/{planId} {
        allow read, write: if isOwner(userId);
      }

      // RAG embeddings subcollection
      match /rag_embeddings/{embeddingId} {
        allow read, write: if isOwner(userId);
      }

      // Memory subcollection (entity graph - people, events, values, conversations)
      match /memory/{memoryDoc=**} {
        allow read, write: if isOwner(userId);
      }

      // Basic Insights subcollection (statistical correlation insights)
      match /basicInsights/{insightId} {
        allow read, write: if isOwner(userId);
      }

      // Insight Feedback subcollection (user feedback on insight accuracy)
      match /insightFeedback/{feedbackId} {
        allow read, write: if isOwner(userId);
      }

      // Insight Learning subcollection (aggregated learning from feedback)
      match /insightLearning/{patternType} {
        allow read, write: if isOwner(userId);
      }

      // Analytics subcollection (mostly server-computed, read-only for client)
      match /analytics/{analyticsDocId} {
        allow read: if isOwner(userId);
        // gap_engagement is writable by the user for engagement tracking
        allow write: if isOwner(userId) && analyticsDocId == 'gap_engagement';

        // Gap engagement history subcollection
        match /history/{engagementId} {
          allow read, write: if isOwner(userId);
        }
      }

      // Reports subcollection (server-generated, read-only for client)
      match /reports/{reportId} {
        allow read: if isOwner(userId);
      }

      // Report preferences subcollection (user-managed privacy settings)
      match /report_preferences/{reportId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId)
          && request.resource.data.keys().size() <= 10;
      }

      // FCM tokens subcollection (write-only, no client reads or deletes)
      match /fcm_tokens/{tokenId} {
        allow create, update: if isOwner(userId)
          && request.resource.data.keys().hasAll(['token', 'platform'])
          && request.resource.data.keys().size() <= 5;
      }
    }

    // Allow Cloud Functions to read/write with admin claims
    match /{document=**} {
      allow read, write: if request.auth.token.admin == true;
    }
  }
}
